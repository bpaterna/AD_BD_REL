
<!doctype html>
<html lang="es" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
        <meta name="author" content="Begoña Paterna">
      
      
        <link rel="canonical" href="https://bpaterna.github.io/AD_BD_REL/5_func_proc.html">
      
      
        <link rel="prev" href="4_transac_excep.html">
      
      
        <link rel="next" href="db_browser_sqlite.html">
      
      
      <link rel="icon" href="assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.20">
    
    
      
        <title>5. Funciones y procedimientos almacenados - Bases de datos relacionales</title>
      
    
    
      <link rel="stylesheet" href="assets/stylesheets/main.e53b48f4.min.css">
      
        
        <link rel="stylesheet" href="assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="stylesheets/extra.css">
    
    <script>__md_scope=new URL(".",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="red" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#funciones-y-procedimientos-almacenados" class="md-skip">
          Saltar a contenido
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Cabecera">
    <a href="." title="Bases de datos relacionales" class="md-header__button md-logo" aria-label="Bases de datos relacionales" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Bases de datos relacionales
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              5. Funciones y procedimientos almacenados
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



  

<nav class="md-nav md-nav--primary md-nav--integrated" aria-label="Navegación" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="." title="Bases de datos relacionales" class="md-nav__button md-logo" aria-label="Bases de datos relacionales" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Bases de datos relacionales
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="0_index.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Guía de uso
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Contenido
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Contenido
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="1_introduccion.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    1. Introducción
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="2_conexiones.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    2. Conexión al SGBD
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="3_operaciones.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    3. Operaciones con la BD
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="4_transac_excep.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    4. Transacciones y excepciones
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
      <a href="5_func_proc.html" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    5. Funciones y procedimientos almacenados
    
  </span>
  

      </a>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Material adicional
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Material adicional
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="db_browser_sqlite.html" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DB Browser
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="funciones-y-procedimientos-almacenados">Funciones y procedimientos almacenados<a class="headerlink" href="#funciones-y-procedimientos-almacenados" title="Permanent link">&para;</a></h1>
<p>Las funciones (FUNCTION) y los procedimientos (PROCEDURE) <strong>no se crean desde el lenguaje Kotlin</strong>, ya que son elementos propios del SGBD. Para definirlos, se utiliza <strong>SQL</strong> y se ejecutan <strong>directamente sobre la base de datos</strong> a través de un cliente SQL.</p>
<p>Tanto <strong>las funciones</strong> como <strong>los procedimientos almacenados</strong> son bloques de código que se guardan en el servidor de la base de datos y que encapsulan una serie de instrucciones SQL.</p>
<p>Se usan para:</p>
<ul>
<li>Reutilizar operaciones complejas</li>
<li>Organizar mejor la lógica de negocio</li>
<li>Mejorar el rendimiento (menos tráfico entre app y BD)</li>
<li>Mantener la integridad de datos</li>
</ul>
<p><strong>Diferencia entre Funciones y Procedimientos</strong></p>
<p>Una <strong>función</strong> está diseñada para <strong>calcular y devolver un resultado</strong>. Se puede usar directamente dentro de una consulta SQL como parte de un SELECT, WHERE, ORDER BY, etc. Las funciones siempre devuelven un valor, que puede ser escalar (un número, texto...), una fila o una tabla.</p>
<p>Un <strong>procedimiento</strong> sirve para <strong>ejecutar acciones</strong> dentro de la base de datos, como insertar registros, modificar datos o gestionar operaciones en bloque. <strong>No devuelve un valor directamente</strong> (aunque puede usar parámetros de salida).</p>
<p>Una vez que las funciones o procedimientos están creados en la base de datos, se pueden <strong>utilizar perfectamente desde Kotlin</strong> a través de <strong>JDBC</strong>, igual que se hace con cualquier consulta SQL:</p>
<ul>
<li>Las funciones se invocan con <strong>SELECT nombre_funcion(...)</strong></li>
<li>Los procedimientos se llaman con <strong>CALL nombre_procedimiento(...)</strong></li>
</ul>
<p>Y desde Kotlin, se gestionan mediante objetos como <strong>PreparedStatement</strong> y <strong>CallableStatement</strong>.</p>
<div class="admonition note">
<p><strong>SQLite</strong> no soporta funciones ni procedimientos almacenados como lo hacen bases de datos como PostgreSQL, MySQL u Oracle. Sin embargo, puedes simular su comportamiento mediante funciones definidas en la aplicación, o vistas y triggers.</p>
</div>
<!--
## 🔹Funciones (FUNCTION)

Una función en PostgreSQL es un bloque que:

- Puede aceptar parámetros
- Devuelve siempre un valor (escalar, tabla o compuesto)
- Se puede usar en consultas SQL (SELECT, WHERE, etc.)
- Puede tener IN, OUT, INOUT


!!!Warning "Sintaxis básica en PostgreSql"
        CREATE [OR REPLACE] FUNCTION nombre_funcion(parámetros)
        RETURNS tipo_de_dato
        LANGUAGE plpgsql
        AS $$
        BEGIN
            -- instrucciones
            RETURN valor;
        END;
        $$;

| Tipo de retorno                | ¿Qué devuelve?                                        | Ejemplo de uso                                           |
|-------------------------------|--------------------------------------------------------|-----------------------------------------------------------|
| `INTEGER`, `TEXT`, etc.       | Un único valor escalar                                | `RETURNS INTEGER`<br>`RETURN x * x;`                      |
| `TABLE(...)`                  | Una tabla (varias columnas y filas)                   | `RETURNS TABLE(codi TEXT, nom TEXT)`<br>`RETURN QUERY ...`|
| `SETOF INTEGER`               | Un conjunto de valores escalares                      | `RETURNS SETOF INTEGER`<br>`RETURN NEXT i;`              |
| `SETOF RECORD`                | Muchas filas con estructura dinámica                  | `RETURNS SETOF RECORD`                                    |
| `%ROWTYPE`                    | Una fila con la estructura de una tabla existente     | `RETURNS institut%ROWTYPE`<br>`SELECT * INTO reg ...`    |
| `RECORD`                      | Una sola fila con columnas genéricas                  | `RETURNS RECORD`<br>`SELECT ... INTO resultado;`         |
| Tipo personalizado            | Una estructura definida con `CREATE TYPE`             | `RETURNS tipo_personalizado`                             |


!!!Tip ""   
    Los siguientes ejemplos  se han creado utilizando el cliente **SQL DBeaver** y la BD **Geo_docker**.


**Funciones que devuelve un valor**{.azul}:

**Ejemplo en SQL:**{.verde} Función que devuelve el cuadrado de un número.

    CREATE OR REPLACE FUNCTION cuadrado(x INTEGER)
    RETURNS INTEGER
    AS $$
    BEGIN
        RETURN x * x;
    END;
    $$ LANGUAGE plpgsql;

La llamada desde **SQL** sería:

    SELECT cuadrado(5);  --Devuelve 25

**En Kotlin**{.verde} la llamda a la función sería:


**Ejemplo_cuadrado.kt**

       fun main() {

            DatabaseLocal.getConnection().use { conn ->
                val sql = "SELECT cuadrado(?)"

                conn.prepareStatement(sql).use { stmt ->
                    stmt.setInt(1, 6) // por ejemplo: x = 6
                    val rs = stmt.executeQuery()

                    if (rs.next()) {
                        val resultado = rs.getInt(1)
                        println("El cuadrado de 6 es: $resultado")
                    }
                }
            }
        }

**Fucniones que devuelven una tabla**{.azul}

**Ejemplo en SQL:**{.verde} Función que devuelve todos los institutos junto con su población y comarca.


        CREATE OR REPLACE FUNCTION obtener_instituts()
        RETURNS TABLE (
            codi TEXT,
            nom TEXT,
            municipi TEXT,
            comarca TEXT
        )
        AS $$
            SELECT 
                i.codi,
                i.nom,
                p.nom AS municipi,
                c.nom_c AS comarca
            FROM institut i
            JOIN poblacio p ON i.cod_m = p.cod_m
            JOIN comarca c ON p.nom_c = c.nom_c
            ORDER BY comarca, municipi;
        $$ LANGUAGE sql;

La llamada desde **SQL** sería:

        SELECT * FROM obtener_instituts();

**En Kotlin**{.verde} la llamda a la función sería:

**Ejemplo_fun_obtener_institutos.kt**

        fun main() {

           DatabaseLocal.getConnection().use { conn ->
                val sql = "SELECT * FROM obtener_instituts()"

                conn.prepareStatement(sql).use { stmt ->
                    val rs = stmt.executeQuery()
                    while (rs.next()) {
                        val codi = rs.getString("codi")
                        val nom = rs.getString("nom")
                        val municipi = rs.getString("municipi")
                        val comarca = rs.getString("comarca")

                        println("Institut: $codi - $nom ($municipi, $comarca)")
                    }
                }
            }
        }


**Fucniones que aceptan filtros como parámetros**{.azul}

**Ejemplo en SQL:**{.verde} Función que devuelve los institutos de una comarca.


        CREATE OR REPLACE FUNCTION instituts_de_comarca(p_nom_c TEXT)
        RETURNS TABLE (
            codi TEXT,
            nom TEXT,
            municipi TEXT,
            comarca TEXT
        )
        AS $$
            SELECT 
                i.codi,
                i.nom,
                p.nom AS municipi,
                c.nom_c AS comarca
            FROM institut i
            JOIN poblacio p ON i.cod_m = p.cod_m
            JOIN comarca c ON p.nom_c = c.nom_c
            WHERE c.nom_c = p_nom_c
            ORDER BY municipi;
        $$ LANGUAGE sql;

La llamada desde **SQL** sería:


        SELECT * FROM instituts_de_comarca('Plana Baixa');

**En Kotlin**{.verde} la llamda a la función sería:

**Ejemplo_fun_instituts_de_comarca.kt**

        fun main() {

            DatabaseLocal.getConnection().use { conn ->
                val sql = "SELECT * FROM instituts_de_comarca(?)"

                conn.prepareStatement(sql).use { stmt ->
                    stmt.setString(1, "Plana Baixa") // Parámetro de entrada
                    val rs = stmt.executeQuery()
                    while (rs.next()) {
                        val codi = rs.getString("codi")
                        val nom = rs.getString("nom")
                        val municipi = rs.getString("municipi")
                        val comarca = rs.getString("comarca")

                        println("Institut: $codi - $nom ($municipi, $comarca)")
                    }
                }
            }
        }

## 🔹Procedimientos (PROCEDURE)


Los procedimientos no devuelven valores directamente, a diferencia de las funciones, pero pueden tener parámetros de entrada (IN), salida (OUT) o ambos (INOUT). Se utilizan para realizar tareas como:

- Inserciones o actualizaciones complejas
- Validaciones
- Operaciones en bloque
- Ejecución de lógica con control de flujo
- Agrupación de instrucciones dentro de una transacción

!!!Warning "Sintaxis básica en PostgreSql"
        CREATE [OR REPLACE] PROCEDURE nombre_procedimiento(
            [parámetro1 tipo [IN|OUT|INOUT]],
            ...
        )
        AS $$
        BEGIN
            -- cuerpo del procedimiento
        END;
        $$ LANGUAGE plpgsql;

**Ejemplo en SQL:**{.verde} Procedimiento que inserta un nuevo instituto y muestra un aviso.

        CREATE OR REPLACE PROCEDURE insertar_institut_resultado(
            IN p_codi VARCHAR,
            IN p_nom VARCHAR,
            IN p_cod_m INTEGER,
            OUT resultado TEXT
        )
        AS $$
        BEGIN
            -- ¿Municipio existe?
            IF NOT EXISTS (SELECT 1 FROM poblacio WHERE cod_m = p_cod_m) THEN
                resultado := 'MUNICIPIO_NO_ENCONTRADO';
                RETURN;
            END IF;

            -- ¿Instituto ya existe?
            IF EXISTS (SELECT 1 FROM institut WHERE codi = p_codi) THEN
                resultado := 'EXISTENTE';
                RETURN;
            END IF;

            -- Insertar instituto
            INSERT INTO institut (codi, nom, cod_m)
            VALUES (p_codi, p_nom, p_cod_m);

            resultado := 'INSERTADO';
        END;
        $$ LANGUAGE plpgsql;

La llamada desde **SQL** sería:

        CALL insertar_institut_resultado('I999', 'Institut Experimental', 12028, NULL);


**En Kotlin**{.verde} la llamda a la función sería:

**Ejemplo_pro_insertar_institut_resultado.kt**

        import java.sql.Types

        fun main() {
           DatabaseLocal.getConnection().use { conn ->
                val sql = "Call insertar_institut_resultado(?, ?, ?, ?)"

                conn.prepareCall(sql).use { stmt ->
                    stmt.setString(1, "I999")
                    stmt.setString(2, "Institut Experimental")
                    stmt.setInt(3, 12028)
                    stmt.registerOutParameter(4, Types.VARCHAR)

                    stmt.execute()

                    val resultado = stmt.getString(4)
                    println("Resultado: $resultado")
                }
            }
        }


## 📊 Resumen diferencias entre función y procedimiento en PostgreSQL

| Característica                    | FUNCIÓN (`FUNCTION`)                             | PROCEDIMIENTO (`PROCEDURE`)                        |
|----------------------------------|--------------------------------------------------|----------------------------------------------------|
| 🔁 Devuelve un valor             | ✅ Sí (con `RETURN`)                             | ❌ No directamente                                 |
| 📥 Parámetros de entrada (`IN`)  | ✅ Sí                                             | ✅ Sí                                               |
| 📤 Parámetros de salida (`OUT`)  | ✅ Sí (como `OUT`, `INOUT`, o `RETURNS`)         | ✅ Sí (`OUT`, `INOUT`)                             |
| 📌 Se invoca con…                | `SELECT nombre_funcion(...)`                     | `CALL nombre_procedimiento(...)`                  |
| 📊 Usable en consultas SQL       | ✅ Sí (puede ir en `SELECT`, `WHERE`, etc.)      | ❌ No                                               |
| 🔄 Puede devolver tablas         | ✅ Sí (`RETURNS TABLE` o `SETOF`)                | ❌ No directamente                                 |
| 🔁 Puede usar `RETURN`           | ✅ Obligatorio                                   | ❌ No se usa `RETURN`, sino solo `CALL`            |
| 🧱 Uso típico                    | Cálculos, validaciones, funciones reutilizables | Procesos complejos, lógica de negocio, transacciones |


-->












                
              </article>
            </div>
          
          
  <script>var tabs=__md_get("__tabs");if(Array.isArray(tabs))e:for(var set of document.querySelectorAll(".tabbed-set")){var labels=set.querySelector(".tabbed-labels");for(var tab of tabs)for(var label of labels.getElementsByTagName("label"))if(label.innerText.trim()===tab){var input=document.getElementById(label.htmlFor);input.checked=!0;continue e}}</script>

<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Volver al principio
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": ".", "features": ["content.code.copy", "content.tabs.link", "navigation.instant", "navigation.top", "navigation.sections", "search.highlight", "search.suggest", "toc.integrate"], "search": "assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copiado al portapapeles", "clipboard.copy": "Copiar al portapapeles", "search.result.more.one": "1 m\u00e1s en esta p\u00e1gina", "search.result.more.other": "# m\u00e1s en esta p\u00e1gina", "search.result.none": "No se encontraron documentos", "search.result.one": "1 documento encontrado", "search.result.other": "# documentos encontrados", "search.result.placeholder": "Teclee para comenzar b\u00fasqueda", "search.result.term.missing": "Falta", "select.version": "Seleccionar versi\u00f3n"}, "version": null}</script>
    
    
      <script src="assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>